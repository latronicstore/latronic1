<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LaTRONIC Store</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Josefin+Sans:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
<style>
/* --- BODY --- */
body { margin: 0; font-family: Arial, sans-serif; background: #121212; color: #ffffffcb; display: flex; min-height: 100vh; }
/* --- ASIDE --- */
aside { position: fixed; top: 0; left: 0; height: 100vh; width: 220px; overflow-y: auto; background: rgba(26, 26, 26, 0.6); -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); padding: 1rem 0.8rem; z-index: 1500; border-right: 1px solid rgba(226, 143, 47, 0.4); transition: background 0.3s ease, backdrop-filter 0.3s ease; }
aside h2 { font-size: 2rem; text-align: center; margin-bottom: 1.5rem; color: #e28f2f; letter-spacing: 1px; }
.menu { list-style: none; padding: 0; margin: 0; background: #1a1a1a; }
.menu>li { margin-bottom: 2rem; margin-left: 1.2rem; position: relative; }
.boton-categoria { display: block; width: 100%; background: transparent; color: #e28f2f; border: none; text-align: left; font-size: 1.1rem; padding: 0.5rem 0.7rem; border-radius: 8px; cursor: pointer; transition: background 0.2s ease, transform 0.1s ease; }
.boton-categoria:hover { background: rgba(226, 143, 47, 0.25); transform: translateX(4px); color: #f0f0f0; }
.submenu { display: none; list-style: none; margin: 0; padding-left: 1rem; border-left: 2px solid rgba(226, 143, 47, 0.3); }
.submenu li { list-style: none; }
.submenu .boton-categoria { font-size: 1rem; padding: 0.4rem 0.7rem; }
.submenu .boton-categoria:hover { background: #f16413b9; color: #050505; border-radius: 5px; }

/* --- CARRITO --- */
.cart-button-container { position: relative; z-index: 2000; }
.carrito { background: #e28f2f; border-radius: 5px; border-color: #1a1a1a; position: relative; z-index: 2001; cursor: pointer; }
.carrito:hover { background: #f16413b9; }

/* --- MAIN --- */
main { margin-left: 230px; padding: 2rem; transition: margin-left 0.3s ease; }
footer { text-align: center; padding: 1rem 0; color: #ffffff9f; font-size: 0.7rem; }

/* --- PRODUCTOS --- */
#contenedor-productos { display: flex; flex-wrap: wrap; gap: 15px; justify-content: flex-start; }
.title { font-family: "Bebas Neue", sans-serif; font-size: 2.5rem; text-align: center; color: #f16413b9; margin: 0; }
#titulo-principal { transition: all 0.3s ease; text-align: center; margin: 0; font-family: "Bebas Neue", sans-serif; font-size: 2.5rem; color: #f16413b9; }
aside.active ~ main #titulo-principal { text-align: center; margin-top: 50px; }
.producto { flex: 0 0 120px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; text-align: center; border: 1px solid #ccc; padding: 6px; margin: 0; background: #1a1a1a; border-radius: 5px; transition: transform 0.3s; overflow: hidden; }
.producto:hover { transform: scale(1.03); }
.agregar-carrito[disabled] { background: #888; color: #ccc; cursor: not-allowed; opacity: 0.7; position: relative; z-index: 1; }
.agregar-carrito { background-color: #e28f2f; color: black; border: none; padding: 0.3rem 0.6rem; cursor: pointer; border-radius: 5px; transition: background 0.3s, color 0.3s; font-weight: bold; font-size: 0.8rem; margin-top: 8px; }
.agregar-carrito:hover { background-color: #f16413b9; color: #fff; }
.toggle-submenu.active { background: #e28e2fa9; color: black; }
.galeria { width: 100%; max-width: 120px; aspect-ratio: 1/1; margin: 0 auto 6px; position: relative; overflow: hidden; border-radius: 6px; }
.main-img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; cursor: zoom-in; display: block; }
.arrow { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.4); color: #fff; border: none; width: 24px; height: 24px; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; z-index: 10; transition: background 0.2s; }
.arrow:hover { background: rgba(0,0,0,0.7); }
.arrow.prev { left: 2px; } .arrow.next { right: 2px; }
/* --- MODAL ZOOM --- */
#zoom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); justify-content: center; align-items: center; z-index: 5000; }
#zoom-modal.show { display: flex; }
#zoom-modal img { max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px; cursor: zoom-out; }
#zoom-modal .close-btn { position: absolute; top: 15px; right: 20px; font-size: 30px; color: #fff; cursor: pointer; }

/* --- HAMBURGER --- */
.hamburger { display: none; position: fixed; top: 15px; left: 15px; font-size: 30px; color: #e28f2f; cursor: pointer; z-index: 3000; }
/* --- RESPONSIVE --- */
@media (max-width: 768px) {
  main { margin-left: 0; padding: 1rem; position: relative; z-index: 1; }
  aside { position: fixed; top: 0; left: -250px; width: 220px; height: 100%; z-index: 2000; transition: left 0.3s ease; }
  aside.active { left: 0; box-shadow: 2px 0 8px rgba(0,0,0,0.5); margin-top: 45px; }
  .hamburger { display: block; top: 45px; left: 15px; font-size: 30px; z-index: 3000; }
  .galeria { width: 100px; aspect-ratio: 1/1; }
  .producto { flex: 0 0 100px; padding: 5px; }
  .arrow { width: 20px; height: 20px; font-size: 14px; }
  #contenedor-productos { justify-content: center; }
  #admin-access { width: 34px; height: 34px; bottom: 12px; right: 12px; font-size: 18px; }
}

/* --- BOTN NEGOCIAR --- */
.negociar { background: linear-gradient(135deg, #f16413, #e28f2f); color: #050505; border: none; padding: 6px 12px; cursor: pointer; border-radius: 25px; font-weight: bold; font-size: 0.8rem; margin-top: 6px; transition: transform 0.2s, box-shadow 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
.negociar:hover { transform: translateY(-2px); color: white; box-shadow: 0 6px 10px rgba(0,0,0,0.4); background: linear-gradient(135deg, #e28f2f, #f16413); }

/* --- BOTN ADMIN FLOTANTE --- */
#admin-access { position: fixed; bottom: 18px; right: 18px; width: 40px; height: 40px; background: linear-gradient(135deg, #e28f2f, #f16413); color: #000; border: none; border-radius: 50%; font-size: 20px; font-weight: bold; cursor: pointer; z-index: 9999; box-shadow: 0 4px 10px rgba(0,0,0,0.4); transition: transform 0.25s, box-shadow 0.3s, background 0.3s; }
#admin-access:hover { transform: scale(1.1); background: linear-gradient(135deg, #f16413, #e28f2f); color: white; box-shadow: 0 6px 15px rgba(0,0,0,0.6); }

/* --- MODAL PRODUCTO --- */
#producto-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: flex-start; overflow-y: auto; z-index: 5000; }
#producto-modal .modal-content { position: relative; background: #2a2a2a; padding: 15px; margin: 60px auto 20px auto; border-radius: 10px; max-width: 400px; width: 90%; display: flex; flex-direction: column; align-items: center; }
#producto-modal .modal-content img { width: 80%; max-width: 300px; height: auto; margin-bottom: 10px; border-radius: 6px; }
#producto-modal #modal-titulo { margin: 5px 0; font-size: 1.1rem; text-align: center; color: #e28f2f; }
#producto-modal #modal-description { margin: 5px 0; font-size: 0.9rem; text-align: center; color: #fff; }
#producto-modal #modal-price { margin: 5px 0; font-size: 1rem; font-weight: bold; color: #e28f2f; }
#producto-modal #modal-stock { margin: 5px 0; font-size: 0.9rem; font-weight: bold; color: rgba(255,0,0,0.8); }
#producto-modal #cerrar-modal { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; color: #fff; cursor: pointer; }

.link { color: #e28f2f; text-decoration: none; }
.link:hover { text-decoration: underline; color:red;}
</style>
</head>
<body>
<div class="hamburger">&#9776;</div>

<aside>
  <h2 class="title">LaTRONIC</h2>
  <ul class="menu">
    <li><a class="boton-categoria" href="index.html">Home</a></li>
    <li>
      <button class="boton-categoria toggle-submenu">New</button>
      <ul class="submenu">
        <li><button class="boton-categoria" data-main="new" data-sub="basketball">Basketball</button></li>
        <li><button class="boton-categoria" data-main="new" data-sub="baseball">Baseball</button></li>
        <li><button class="boton-categoria" data-main="new" data-sub="football">Football</button></li>
        <li><button class="boton-categoria" data-main="new" data-sub="hockey">Hockey</button></li>
        <li><button class="boton-categoria" data-main="new" data-sub="ufc">UFC</button></li>
        <li><button class="boton-categoria" data-main="new" data-sub="soccer">Soccer</button></li>
        <li><button class="boton-categoria" data-main="new" data-sub="olympics">Olympics</button></li>
        <li><button class="boton-categoria" data-main="new" data-sub="boxing">Boxing</button></li>
        <li><button class="boton-categoria" data-main="new" data-sub="racecar">Racecar</button></li>
        <li><button class="boton-categoria" data-main="new" data-sub="pokemon">Pokemon</button></li>
        <li><button class="boton-categoria" data-main="new" data-sub="disney">Disney</button></li>
        <li><button class="boton-categoria" data-main="new" data-sub="avengers">Avenger & Marvel</button></li>
      </ul>
    </li>
    <li>
      <button class="boton-categoria toggle-submenu">Used</button>
      <ul class="submenu">
        <li><button class="boton-categoria" data-main="used" data-sub="basketball">Basketball</button></li>
        <li><button class="boton-categoria" data-main="used" data-sub="baseball">Baseball</button></li>
        <li><button class="boton-categoria" data-main="used" data-sub="football">Football</button></li>
        <li><button class="boton-categoria" data-main="used" data-sub="hockey">Hockey</button></li>
        <li><button class="boton-categoria" data-main="used" data-sub="ufc">UFC</button></li>
        <li><button class="boton-categoria" data-main="used" data-sub="soccer">Soccer</button></li>
        <li><button class="boton-categoria" data-main="used" data-sub="olympics">Olympics</button></li>
        <li><button class="boton-categoria" data-main="used" data-sub="boxing">Boxing</button></li>
        <li><button class="boton-categoria" data-main="used" data-sub="racecar">Racecar</button></li>
        <li><button class="boton-categoria" data-main="used" data-sub="pokemon">Pokemon</button></li>
        <li><button class="boton-categoria" data-main="used" data-sub="disney">Disney</button></li>
        <li><button class="boton-categoria" data-main="used" data-sub="avengers">Avenger & Marvel</button></li>
      </ul>
    </li>
    <li>
      <button class="boton-categoria toggle-submenu">More</button>
      <ul class="submenu">
        <li><button class="boton-categoria" data-main="more" data-sub="history">History</button></li>
        <li><button class="boton-categoria" data-main="more" data-sub="magazines">Magazines</button></li>
        <li><button class="boton-categoria" data-main="more" data-sub="comics">Comics</button></li>
        <li><button class="boton-categoria" data-main="more" data-sub="figures">Figures</button></li>
        <li><button class="boton-categoria" data-main="more" data-sub="toys">Toys</button></li>
      </ul>
    </li>
    <li class="cart-button-container">
      <button id="ir-carrito" class="carrito"> Cart (<span id="cart-count">0</span>)</button>
      <footer>
        <a href="aboutus.html" class="link">About Us</a> | <a href="contactus.html" class="link">Contact Us</a><br>
        Email-latronicstore@gmail.com<br>
        Located in Connecticut, USA<br>
        &copy; 2024 LaTRONIC LLC. All rights reserved.
      </footer>
    </li>  
  </ul>
</aside>

<main>
  <h1 id="titulo-principal">All Products</h1>
  <div id="contenedor-productos"></div>
  <button id="admin-access" title="Admin Panel">锔</button>
</main>

<!-- MODAL NEGOCIAR -->
<div id="negociar-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);justify-content:center;align-items:center;z-index:6000;">
  <div style="background:#2a2a2a;padding:20px;border-radius:10px;display:flex;flex-direction:column;align-items:center;position:relative;">
    <span id="cerrar-negociar" style="position:absolute;top:10px;right:15px;font-size:28px;cursor:pointer;color:#fff;">&times;</span>
    <h2 id="negociar-producto" style="color:#e28f2f;margin-bottom:10px;"></h2>
    <input type="email" id="negociar-email" placeholder="Your Email" style="margin-bottom:10px;padding:5px;border-radius:5px;border:none;">
    <input type="number" id="negociar-precio" placeholder="Offer Price" style="margin-bottom:10px;padding:5px;border-radius:5px;border:none;">
    <button id="enviar-negociacion" style="padding:5px 10px;border:none;border-radius:5px;background:#e28f2f;color:black;font-weight:bold;cursor:pointer;">Send Offer</button>
    <p id="negociar-status" style="color:#fff;margin-top:10px;"></p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@2.4.1/dist/email.min.js"></script>
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

<script>
emailjs.init("g62s-TyalISrbYkzz");

document.addEventListener("DOMContentLoaded", async () => {
  const contenedor = document.getElementById("contenedor-productos");
  const cartCountEl = document.getElementById("cart-count");
  const toggleButtons = document.querySelectorAll(".toggle-submenu");
  const hamburger = document.querySelector(".hamburger");
  const aside = document.querySelector("aside");
  const socket = io(); // Conexi贸n Socket.IO

  // --- Men煤 responsive ---
  hamburger.addEventListener("click", () => aside.classList.toggle("active"));
  toggleButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const submenu = btn.nextElementSibling;
      const isVisible = submenu.style.display === "block";
      document.querySelectorAll(".submenu").forEach(sm => sm.style.display = "none");
      document.querySelectorAll(".toggle-submenu").forEach(b => b.classList.remove("active"));
      if (!isVisible) { submenu.style.display = "block"; btn.classList.add("active"); }
    });
  });

  // --- Obtener productos desde API ---
  async function obtenerProductos() {
    try {
      const res = await fetch("http://localhost:3000/api/productos", { cache: "no-store" });
      if (!res.ok) throw new Error("Error cargando productos");
      const data = await res.json();
      const productosGuardados = JSON.parse(localStorage.getItem("productos")) || [];
      const productosFinal = data.map(p => {
        const local = productosGuardados.find(lp => lp.id === p.id);
        return local ? { ...p, stock: local.stock, price: local.price, soldOut: local.soldOut||false, stockOriginal: local.stockOriginal || local.stock } 
                     : { ...p, stockOriginal: p.stock };
      });
      localStorage.setItem("productos", JSON.stringify(productosFinal));
      return productosFinal;
    } catch (err) {
      const localData = JSON.parse(localStorage.getItem("productos")) || [];
      if (localData.length === 0) alert("No se pudo cargar productos y no hay datos guardados.");
      return localData;
    }
  }

  let productos = await obtenerProductos();

  // --- Render productos ---
  function renderProductos(lista, scrollY = null) {
    const carrito = JSON.parse(localStorage.getItem("productos-en-cart")) || [];
    contenedor.innerHTML = "";

    lista.forEach(prod => {
      const div = document.createElement("div");
      div.className = "producto";

      // Galer铆a
      const galeria = document.createElement("div");
      galeria.className = "galeria";

      const mainImg = document.createElement("img");
      mainImg.className = "main-img";
      mainImg.src = prod.imagenes[0];
      mainImg.dataset.index = 0;

      const prev = document.createElement("button");
      prev.className = "arrow prev"; prev.innerHTML = "&#9664;";
      const next = document.createElement("button");
      next.className = "arrow next"; next.innerHTML = "&#9654;";
      if (prod.imagenes.length <= 1) { prev.style.display = "none"; next.style.display = "none"; }

      prev.addEventListener("click", e => { 
        e.stopPropagation(); 
        let idx = parseInt(mainImg.dataset.index); 
        idx = (idx - 1 + prod.imagenes.length) % prod.imagenes.length; 
        mainImg.dataset.index = idx; mainImg.src = prod.imagenes[idx]; 
      });
      next.addEventListener("click", e => { 
        e.stopPropagation(); 
        let idx = parseInt(mainImg.dataset.index); 
        idx = (idx + 1) % prod.imagenes.length; 
        mainImg.dataset.index = idx; mainImg.src = prod.imagenes[idx]; 
      });

      galeria.appendChild(prev); 
      galeria.appendChild(mainImg); 
      galeria.appendChild(next);

      // Informaci贸n
      const h3 = document.createElement("h3"); 
      h3.textContent = prod.titulo;

      const carritoItem = carrito.find(c => c.id === prod.id);
      const cantidadEnCarrito = carritoItem ? carritoItem.quantity : 0;
      const stockRestante = prod.stock - cantidadEnCarrito;

      const pStock = document.createElement("p"); 
      pStock.className = "stock"; 
      pStock.textContent = stockRestante > 0 ? `Stock: ${stockRestante}` : "Out of stock";
      pStock.style.color = stockRestante > 0 ? "gray" : "red";

      const pPrice = document.createElement("p"); 
      pPrice.style.color = "#e28f2f"; 
      pPrice.style.fontWeight = "bold"; 
      pPrice.textContent = "$"+prod.price;

      // Bot贸n agregar al carrito
      const btn = document.createElement("button"); 
      btn.className = "agregar-carrito"; 
      btn.dataset.id = prod.id; 
      btn.disabled = stockRestante <= 0;
      btn.textContent = stockRestante > 0 ? (carritoItem ? `Add (${carritoItem.quantity})` : "Add") : "Out of stock";

      btn.addEventListener("click", () => {
        let carrito = JSON.parse(localStorage.getItem("productos-en-cart")) || [];
        const index = carrito.findIndex(c => c.id === prod.id);
        if (cantidadEnCarrito < prod.stock) {
          if (index !== -1) carrito[index].quantity += 1;
          else carrito.push({ id: prod.id, titulo: prod.titulo, price: prod.price, quantity: 1 });
          localStorage.setItem("productos-en-cart", JSON.stringify(carrito));
        }
        cartCountEl.textContent = carrito.reduce((acc,i)=>acc+i.quantity,0);
        renderProductos(lista, window.scrollY);
      });

      // Bot贸n negociar
      const btnNegociar = document.createElement("button");
      btnNegociar.className = "negociar"; 
      btnNegociar.textContent = "Send Offer";
      btnNegociar.addEventListener("click", () => {
        document.getElementById("negociar-modal").style.display = "flex";
        document.getElementById("negociar-producto").textContent = prod.titulo;
      });

      div.appendChild(galeria); 
      div.appendChild(h3); 
      div.appendChild(pStock); 
      div.appendChild(pPrice); 
      div.appendChild(btn); 
      div.appendChild(btnNegociar);
      contenedor.appendChild(div);
    });

    if(scrollY !== null) window.scrollTo(0, scrollY);
    const carritoActual = JSON.parse(localStorage.getItem("productos-en-cart")) || [];
    cartCountEl.textContent = carritoActual.reduce((acc,i)=>acc+i.quantity,0);
  }

  //  --- NUEVO BLOQUE: Mostrar producto filtrado si viene desde index.html ---
  const filtroId = localStorage.getItem("filtro-producto");

  if (filtroId) {
    const productoFiltrado = productos.filter(p => p.id === filtroId);
    renderProductos(productoFiltrado);
    localStorage.removeItem("filtro-producto"); // limpiar para futuras visitas
  } else {
    renderProductos(productos);
  }
  //  --- FIN BLOQUE NUEVO ---

  // --- SOCKET.IO: escuchar actualizaciones desde admin ---
  socket.on("actualizar-productos", async () => {
    productos = await obtenerProductos();
    renderProductos(productos, window.scrollY);
  });

  // --- ADMIN ---
  document.getElementById("admin-access").addEventListener("click", () => window.location.href = "/admin.html");

  // --- CARRITO ---
  document.getElementById("ir-carrito").addEventListener("click", () => window.location.href = "/cart.html");

  // --- MODAL NEGOCIAR ---
  document.getElementById("cerrar-negociar").addEventListener("click", () => { 
    document.getElementById("negociar-modal").style.display = "none"; 
  });
  document.getElementById("enviar-negociacion").addEventListener("click", () => {
    const email = document.getElementById("negociar-email").value;
    const oferta = document.getElementById("negociar-precio").value;
    if(!email || !oferta) { alert("Por favor completa todos los campos"); return; }
    emailjs.send("service_id","template_id",{ 
      producto: document.getElementById("negociar-producto").textContent, email, oferta 
    })
    .then(()=>{
      document.getElementById("negociar-status").textContent="Offer sent!"; 
      document.getElementById("negociar-modal").style.display="none"; 
    })
    .catch(err=>{
      document.getElementById("negociar-status").textContent="Error sending offer"; 
      console.error(err); 
    });
  });
});
</script>


</body>
</html>
